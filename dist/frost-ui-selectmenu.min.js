!function(e,t){"use strict";"object"==typeof module&&"object"==typeof module.exports?module.exports=t:t(e)}(window,(function(e){"use strict";if(!e)throw new Error("FrostUI-SelectMenu requires a Window.");if(!("UI"in e))throw new Error("FrostUI-SelectMenu requires FrostUI.");const t=e.Core,s=e.dom,i=(e.QuerySet,e.UI),n=e.document;class l extends i.BaseComponent{constructor(e,i){let n;super(e,i),this._placeholderText=this._settings.placeholder,this._maxSelections=this._settings.maxSelections,this._multiple=s.getProperty(this._node,"multiple"),this._disabled=s.getProperty(this._node,"disabled"),this._readonly=s.hasAttribute(this._node,"readonly"),this._data=[],this._lookup={},this._getData=null,this._getResults=null,t.isFunction(this._settings.getResults)?(this._getResultsCallbackInit(),this._getResultsInit()):n=t.isPlainObject(this._settings.data)?this.constructor._getDataFromObject(this._settings.data):t.isArray(this._settings.data)?this._settings.data:this.constructor._getDataFromDOM(this._node),n&&(this._data=this.constructor._parseData(n),this._lookup=this.constructor._parseDataLookup(n),this._getDataInit());const l=s.getValue(this._node);this._render(),this._loadValue(l),this._events()}destroy(){this._popper&&this._popper.destroy(),s.removeAttribute(this._node,"tabindex"),s.removeEvent(this._node,"focus.frost.selectmenu"),s.removeClass(this._node,"visually-hidden"),s.remove(this._menuNode),s.remove(this._toggle),super.destroy()}hide(){!this._animating&&s.isConnected(this._menuNode)&&s.triggerOne(this._node,"hide.frost.selectmenu")&&(this._animating=!0,this._refreshPlaceholder(),s.setValue(this._searchInput,""),s.fadeOut(this._menuNode,{duration:this._settings.duration}).then(e=>{s.empty(this._itemsList),s.detach(this._menuNode),s.setAttribute(this._toggle,"aria-expanded",!1),s.triggerEvent(this._node,"hidden.frost.selectmenu")}).catch(e=>{}).finally(e=>{this._animating=!1}))}show(){this._disabled||this._readonly||this._animating||s.isConnected(this._menuNode)||!s.triggerOne(this._node,"show.frost.selectmenu")||(this._getData({}),this._multiple&&!s.hasChildren(this._itemsList)||(this._animating=!0,s.append(n.body,this._menuNode),this.update(),s.fadeIn(this._menuNode,{duration:this._settings.duration}).then(e=>{s.setAttribute(this._toggle,"aria-expanded",!0),s.triggerEvent(this._node,"shown.frost.selectmenu")}).catch(e=>{}).finally(e=>{this._animating=!1})))}toggle(){s.isConnected(this._menuNode)?this.hide():this.show()}update(){this._popper.update()}static autoHide(e){const t=s.getDataset(e,"target"),i=s.find(".selectmenu-menu");for(const n of i){if(e&&s.hasDescendent(n,e))continue;const i=s.getDataset(n,"target");if(i===t)continue;const l=s.findOne(i);this.init(l).hide()}}}Object.assign(l.prototype,{_events(){s.addEvent(this._node,"focus.ui.selectmenu",e=>{this._disabled||(this._multiple?s.focus(this._searchInput):s.focus(this._toggle))}),s.addEvent(this._menuNode,"mousedown.ui.selectmenu",e=>{e.preventDefault()}),s.addEventDelegate(this._itemsList,"mouseup.ui.selectmenu",'[data-ui-action="select"]',e=>{e.preventDefault();const t=s.getDataset(e.currentTarget,"uiValue");this._selectValue(t)}),s.addEventDelegate(this._itemsList,"mouseover.ui.selectmenu",".selectmenu-action:not(.disabled)",DOM.debounce(e=>{const t=s.find(".selectmenu-focus",this._itemsList);s.removeClass(t,"selectmenu-focus"),s.addClass(e.currentTarget,"selectmenu-focus")})),s.addEvent(this._searchInput,"keydown.ui.selectmenu",e=>{if(!["ArrowDown","ArrowUp","Backspace","Enter","Escape"].includes(e.key))return;if("Backspace"===e.key){if(this._multiple&&this._value.length&&!s.getValue(this._searchInput)){e.preventDefault();const t=this._value.pop(),i=this._findValue(t);this._refreshMulti(),s.setValue(this._searchInput,i.text),s.focus(this._searchInput),this._updateSearchWidth(),s.triggerEvent(this._searchInput,"input.ui.selectmenu")}return}if(this._multiple&&!s.isConnected(this._menuNode)&&["ArrowDown","ArrowUp","Enter"].includes(e.key))return this.show();if("Escape"===e.key)return s.blur(this._searchInput),void(this._multiple?s.focus(this._searchInput):s.focus(this._toggle));const t=s.findOne(".selectmenu-focus",this._itemsList);if("Enter"===e.key){if(t){const e=s.getDataset(t,"uiValue");this._selectValue(e)}return}let i;if(t)switch(e.key){case"ArrowDown":i=s.nextAll(t,".selectmenu-action:not(.disabled)").shift();break;case"ArrowUp":i=s.prevAll(t,".selectmenu-action:not(.disabled)").pop()}else i=s.findOne(".selectmenu-action:not(.disabled)",this._itemsList);i&&(s.removeClass(t,"selectmenu-focus"),s.addClass(i,"selectmenu-focus"))});const e=t.debounce(e=>{s.empty(this._itemsList),this._getData({term:e})},this._settings.debounceInput);s.addEvent(this._searchInput,"input.ui.selectmenu",DOM.debounce(t=>{this._multiple&&this._updateSearchWidth();const i=s.getValue(this._searchInput);i.length<this._settings.minSearch||(this._multiple&&this.show(),e(i))})),this._settings.getResults&&s.addEvent(this._itemsList,"scroll.ui.selectmenu",t.throttle(e=>{if(this._request||!this._showMore)return;const t=s.height(this._itemsList),i=s.height(this._itemsList,DOM.SCROLL_BOX);if(s.getScrollY(this._itemsList)>=i-t-t/4){const e=s.getValue(this._searchInput),t=this._data.length;this._getData({term:e,offset:t})}},250,!1)),this._multiple?this._eventsMulti():this._eventsSingle()},_eventsMulti(){s.addEvent(this._searchInput,"focus.ui.selectmenu",e=>{s.hide(this._placeholder),s.detach(this._placeholder),s.addClass(this._toggle,"focus")}),s.addEvent(this._searchInput,"blur.ui.selectmenu",e=>{s.hasDataset(this._toggle,"preFocus")||(s.removeClass(this._toggle,"focus"),this.hide())}),s.addEvent(this._toggle,"mousedown.ui.selectmenu",t=>{s.hasClass(this._toggle,"focus")?s.setDataset(this._toggle,"uiPreFocus",!0):(s.hide(this._placeholder),s.addClass(this._toggle,"focus")),this.show(),s.addEventOnce(e,"mouseup.ui.selectmenu",e=>{s.hasDataset(this._toggle,"uiPreFocus")&&s.removeDataset(this._toggle,"uiPreFocus"),s.focus(this._searchInput)})}),s.addEventDelegate(this._toggle,"click.ui.selectmenu",'[data-ui-action="clear"]',e=>{e.preventDefault();const t=s.parent(e.currentTarget),i=s.index(t);this._value.splice(i,1),this._setValue(this._value),s.focus(this._searchInput)})},_eventsSingle(){s.addEvent(this._searchInput,"blur.ui.selectmenu",e=>{this.hide()}),s.addEvent(this._toggle,"mousedown.ui.selectmenu",t=>{s.isConnected(this._menuNode)?this.hide():(this.show(),s.addEventOnce(e,"mouseup.ui.selectmenu",e=>{s.focus(this._searchInput)}))}),s.addEvent(this._toggle,"keydown.ui.selectmenu",e=>{/^.$/u.test(e.key)&&(this.show(),s.focus(this._searchInput))}),this._settings.allowClear&&s.addEventDelegate(this._toggle,"click.ui.selectmenu",'[data-ui-action="clear"]',e=>{this._setValue(null)})}}),Object.assign(l.prototype,{_cloneValue(e){const s=this._findValue(e);if(!s)return s;const i=t.extend({},s);return delete i.element,i},_findValue(e){return e in this._lookup?this._lookup[e]:null},_loadValue(e){!e||!this._getResults||!this._multiple&&this._findValue(e)||this._multiple&&e.every(e=>this._findValue(e))?this._setValue(e):this._getResults({value:e}).then(t=>this._setValue(e))},_refresh(){this._multiple?this._refreshMulti():this._refreshSingle()},_refreshDisabled(){const e=this._multiple?this._searchInput:this._toggle;this._disabled?(s.addClass(this._toggle,"disabled"),s.setAttribute(e,"tabindex","-1")):(s.removeClass(this._toggle,"disabled"),s.removeAttribute(e,"tabindex")),this._readonly&&s.addClass(this._toggle,"readonly")},_refreshMulti(){if(this._value||(this._value=[]),this._maxSelections&&this._value.length>this._maxSelections&&(this._value=this._value.slice(0,this._maxSelections)),this._value=this._value.filter(e=>{const t=this._findValue(e);return t&&!t.disabled}),s.detach(this._searchInput),s.empty(this._node),s.empty(this._toggle),this._refreshDisabled(),this._refreshPlaceholder(),this._value.length)for(const e of this._value){const t=this._findValue(e);s.append(this._node,t.element);const i=this._renderMultiSelection(t);s.append(this._toggle,i)}s.append(this._toggle,this._searchInput)},_refreshPlaceholder(){this._multiple&&this._value.length||!this._multiple&&this._value?s.hide(this._placeholder):(s.show(this._placeholder),s.prepend(this._toggle,this._placeholder))},_refreshSingle(){const e=this._findValue(this._value);if(e&&!e.disabled||(this._value=null),s.empty(this._node),s.empty(this._toggle),this._refreshDisabled(),this._refreshPlaceholder(),!this._value)return;s.append(this._node,e.element);const t=this._settings.renderSelection(e);s.setHTML(this._toggle,this._settings.sanitize(t)),this._settings.allowClear&&s.append(this._toggle,this._clear)},_selectValue(e){const t=this._findValue(e);if(t){if(e=t.value,this._multiple){const t=this._value.indexOf(e);t>=0?(this._value.splice(t,1),e=this._value):e=this._value.concat([e])}this._setValue(e),this._settings.closeOnSelect?this.hide():this._getData({}),this._refreshPlaceholder(),s.setValue(this._searchInput,""),this._multiple?s.focus(this._searchInput):s.focus(this._toggle)}},_setValue(e){this._value=e,this._refresh()},_updateSearchWidth(){const e=s.create("span",{text:s.getValue(this._searchInput),class:"d-inline-block",style:{fontSize:s.css(this._searchInput,"fontSize"),whiteSpace:"pre-wrap"}});s.append(n.body,e);const t=s.width(e);s.setStyle(this._searchInput,"width",t+2),s.remove(e)}}),Object.assign(l.prototype,{_getDataInit(){this._getData=({term:e=null})=>{if(this._settings.minSearch&&(!e||e.length<this._settings.minSearch))return this.update();if(this._multiple&&this._maxSelections&&this._value.length>=this._maxSelections)return this._renderInfo(this._settings.lang.maxSelections);let t=this._data;e&&(t=this._settings.sortResults(t.reduce((e,t)=>(t.children?e.push(...t.children):e.push(t),e),[]),e).filter(t=>this._settings.isMatch(t,e))),this._renderResults(t),this.update()}},_getResultsInit(){this._getData=({offset:e=0,term:t=null})=>{if(this._request&&this._request.cancel&&(this._request.cancel(),this._request=null),e||s.empty(this._itemsList),this._settings.minSearch&&(!t||t.length<this._settings.minSearch))return this.update();if(this._multiple&&this._maxSelections&&this._value.length>=this._maxSelections)return this._renderInfo(this._settings.lang.maxSelections);const i=this._renderInfo(this._settings.lang.loading),n=this._getResults({offset:e,term:t});n.then(e=>{this._renderResults(e.results)}).catch(e=>{}).finally(e=>{s.remove(i),this.update(),this._request===n&&(this._request=null)})}},_getResultsCallbackInit(){this._getResults=e=>{e.offset||(this._data=[]);const t=this._settings.getResults(e);return this._request=Promise.resolve(t),this._request.then(e=>{const t=this.constructor._parseData(e.results);return this._data.push(...t),this._showMore=e.showMore,Object.assign(this._lookup,this.constructor._parseDataLookup(this._data)),e}),this._request}}}),Object.assign(l.prototype,{_render(){this._multiple?this._renderToggleMulti():(this._settings.allowClear&&this._renderClear(),this._renderToggleSingle()),this._renderPlaceholder(),this._renderMenu(),s.addClass(this._node,"visually-hidden"),s.setAttribute(this._node,"tabindex","-1"),s.after(this._node,this._toggle)},_renderClear(){this._clear=s.create("button",{html:'<small class="icon-cancel"></small>',class:"close float-end me-5 lh-base",dataset:{uiAction:"clear"}})},_renderGroup(e){return s.create("div",{html:this._settings.sanitize(this._settings.renderResult(e)),class:"selectmenu-group"})},_renderInfo(e){const t=s.create("button",{html:this._settings.sanitize(e),class:"selectmenu-item text-secondary"});return s.append(this._itemsList,t),this.update(),t},_renderItem(e){const t=this._multiple&&this._value.includes(e.value)||!this._multiple&&e.value==this._value,{option:i,...n}=e,l=s.create("div",{html:this._settings.sanitize(this._settings.renderResult(n,t)),class:"selectmenu-item selectmenu-action",dataset:{uiAction:"select",uiValue:e.value}});return t&&s.addClass(l,"active"),e.disabled&&s.addClass(l,"disabled"),l},_renderMenu(){if(this._menuNode=s.create("div",{class:"selectmenu-menu",dataset:{target:"#"+s.getAttribute(this._node,"id")}}),!this._multiple){const e=s.create("div",{class:"p-1"});s.append(this._menuNode,e);const t=s.create("div",{class:"form-input"});s.append(e,t),this._searchInput=s.create("input",{class:"input-filled"}),s.append(t,this._searchInput);const i=s.create("div",{class:"ripple-line"});s.append(t,i)}this._itemsList=s.create("div",{class:"selectmenu-items"}),s.append(this._menuNode,this._itemsList);const e={reference:this._toggle,placement:this._settings.placement,position:this._settings.position,fixed:this._settings.fixed,spacing:this._settings.spacing,minContact:this._settings.minContact};this._settings.fullWidth&&(e.afterUpdate=(e,t)=>{const i=s.width(t,DOM.BORDER_BOX);s.setStyle(e,"width",i)},e.beforeUpdate=e=>{s.setStyle(e,"width","")}),this._popper=new i.Popper(this._menuNode,e)},_renderMultiSelection(e){const t=s.create("div",{class:"btn-group"}),i=s.create("div",{html:'<small class="icon-cancel"></small>',class:"btn btn-sm btn-outline-secondary",dataset:{uiAction:"clear"}});s.append(t,i);const n=this._settings.renderSelection(e),l=s.create("div",{html:this._settings.sanitize(n),class:"btn btn-sm btn-secondary"});return s.append(t,l),t},_renderPlaceholder(){this._placeholder=s.create("span",{html:this._settings.sanitize(this._placeholderText),class:"selectmenu-placeholder"})},_renderResults(e){if(!e.length)return this._renderInfo(this._settings.lang.noResults);for(const t of e){const e=t.children?this._renderGroup(t):this._renderItem(t);s.append(this._itemsList,e)}let t=s.findOne(".selectmenu-action.active",this._itemsList);t||(t=s.findOne(".selectmenu-action:not(.disabled)",this._itemsList)),t&&s.addClass(t,"selectmenu-focus")},_renderToggleSingle(){this._toggle=s.create("button",{class:[s.getAttribute(this._node,"class")||"","selectmenu-toggle position-relative text-start"],dataset:{target:"#"+s.getAttribute(this._node,"id")}})},_renderToggleMulti(){this._toggle=s.create("div",{class:[s.getAttribute(this._node,"class")||"","selectmenu-multi d-flex flex-wrap position-relative text-start"],dataset:{target:"#"+s.getAttribute(this._node,"id")}}),this._searchInput=s.create("input",{class:"selectmenu-multi-input"})}}),Object.assign(l.prototype,{data(){return this._multiple?this._value.map(e=>this._cloneValue(e)):this._cloneValue(this._value)},disable(){return s.setAttribute(this._node,"disabled",!0),this._disabled=!0,this._refreshDisabled(),this},enable(){return s.removeAttribute(this._node,"disabled"),this._disabled=!1,this._refreshDisabled(),this},getMaxSelections(){return this._maxSelections},getPlaceholder(){return this._placeholderText},getValue(){return this._value},setMaxSelections(e){return this._maxSelections=e,this.hide(),this._refresh(),this},setPlaceholder(e){return this._placeholderText=e,s.remove(this._placeholder),this._renderPlaceholder(),this._refresh(),this},setValue(e){return this._disabled||this._loadValue(e),this}}),Object.assign(l,{_buildOption:e=>s.create("option",{text:e.text,value:e.value,properties:{selected:!0}}),_getDataFromDOM(e){return s.children(e).map(e=>{const t=s.getDataset(e);return s.is(e,"option")?{text:s.getText(e),value:s.getValue(e),...t}:{text:s.getAttribute(e,"label"),children:this._getDataFromDOM(e),...t}})},_getDataFromObject:e=>Object.entries(e).map(([e,t])=>({value:e,text:t})),_parseData(e){for(const t of e)t.children?this._parseData(t.children):t.element=this._buildOption(t);return e},_parseDataLookup(e,s={}){for(const i of e)e.children?this._parseDataLookup(e.children,s):s[i.value]=t.extend({},i);return s}}),l.defaults={placeholder:"",lang:{loading:"Loading..",maxSelections:"Selection limit reached.",noResults:"No results"},data:null,getResults:null,isMatch:(e,s)=>{const i=t.escapeRegExp(s);if(new RegExp(i,"i").test(e.text))return!0;const n=s.normalize("NFD").replace(/[\u0300-\u036f]/g,""),l=t.escapeRegExp(n);return!!new RegExp(l,"i").test(e.text)},renderResult:e=>e.text,renderSelection:e=>e.text,sanitize:e=>s.sanitize(e),sortResults:(e,t)=>e.sort((e,s)=>{const i=e.text.toLowerCase(),n=s.text.toLowerCase();if(t){const e=i.indexOf(t)-n.indexOf(t);if(e)return e}return i.localeCompare(n)}),maxSelections:0,minSearch:0,allowClear:!1,closeOnSelect:!0,fullWidth:!0,debounceInput:250,duration:100,placement:"bottom",position:"start",fixed:!1,spacing:3,minContact:!1},i.initComponent("selectmenu",l),i.SelectMenu=l}));