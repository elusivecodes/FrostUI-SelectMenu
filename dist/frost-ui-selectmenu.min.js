!function(t,e){"use strict";"object"==typeof module&&"object"==typeof module.exports?module.exports=e:e(t)}(window,(function(t){"use strict";if(!t)throw new Error("FrostUI-SelectMenu requires a Window.");if(!("UI"in t))throw new Error("FrostUI-SelectMenu requires FrostUI.");const e=t.Core,s=t.dom,i=t.QuerySet,n=t.UI,a=t.document;class l{constructor(t,i){let n;this._node=t,this._settings=e.extend({},this.constructor.defaults,s.getDataset(this._node),i),this._multiple=s.getProperty(this._node,"multiple"),this._disabled=s.getProperty(this._node,"disabled"),this._getData=null,this._getResults=null,e.isFunction(this._settings.getResults)?(this._getResults=t=>{t.offset||(this._data=[]);const e=this._settings.getResults(t);return this._request=Promise.resolve(e),this._request.then(t=>{const e=this.constructor._parseData(t.results);return this._data.push(...e),this._showMore=t.showMore,Object.assign(this._lookupData,this.constructor._parseDataLookup(this._data)),t}),this._request},this._getData=({offset:t=0,term:e=null})=>{if(this._request&&this._request.cancel&&(this._request.cancel(),this._request=null),t||s.empty(this._itemsList),this._multiple&&this._settings.maxSelect&&this._value.length>=this._settings.maxSelect){const t=s.create("li",{html:this._settings.sanitize(this._settings.lang.maxSelect),class:"selectmenu-item text-secondary"});return s.append(this._itemsList,t),void this._popper.update()}const i=s.create("li",{html:this._settings.sanitize(this._settings.lang.loading),class:"selectmenu-item text-secondary"});s.append(this._itemsList,i),this._popper.update();const n=this._getResults({offset:t,term:e});n.then(t=>{this._renderResults(t.results)}).catch(t=>{}).finally(t=>{s.remove(i),this._popper.update(),this._request===n&&(this._request=null)})}):n=e.isPlainObject(this._settings.data)?this.constructor._getDataFromObject(this._settings.data):e.isArray(this._settings.data)?this._settings.data:this.constructor._getDataFromDOM(this._node),this._data=[],this._lookupData={},n&&(this._data=this.constructor._parseData(n),this._lookupData=this.constructor._parseDataLookup(n),this._getData=({term:t=null})=>{if(this._multiple&&this._settings.maxSelect&&this._value.length>=this._settings.maxSelect){const t=s.create("li",{html:this._settings.sanitize(this._settings.lang.maxSelect),class:"selectmenu-item text-secondary"});return s.append(this._itemsList,t),void this._popper.update()}let e=this._data;t&&(e=this._settings.sortResults(e.reduce((t,e)=>(e.children?t.push(...e.children):t.push(e),t),[]),t).filter(e=>this._settings.isMatch(e,t))),this._renderResults(e),this._popper.update()});const a=s.getValue(this._node);this._render(),this.setValue(a),this._events(),s.setData(this._node,"selectmenu",this)}destroy(){this._popper&&this._popper.destroy(),s.removeData(this._node,"selectmenu")}hide(){!this._settings.inline&&!this._animating&&s.isConnected(this._menuNode)&&s.triggerOne(this._node,"hide.frost.selectmenu")&&(this._animating=!0,this._refreshPlaceholder(),s.setValue(this._searchInput,""),s.fadeOut(this._menuNode,{duration:this._settings.duration}).then(t=>{s.empty(this._itemsList),s.detach(this._menuNode),s.setAttribute(this._toggle,"aria-expanded",!1),s.triggerEvent(this._node,"hidden.frost.selectmenu")}).catch(t=>{}).finally(t=>{this._animating=!1}))}show(){this._settings.inline||this._animating||s.isConnected(this._menuNode)||s.is(this._node,":disabled")||!s.triggerOne(this._node,"show.frost.selectmenu")||(this._animating=!0,s.append(a.body,this._menuNode),this._getData({}),this._popper.update(),s.fadeIn(this._menuNode,{duration:this._settings.duration}).then(t=>{s.setAttribute(this._toggle,"aria-expanded",!0),s.triggerEvent(this._node,"shown.frost.selectmenu")}).catch(t=>{}).finally(t=>{this._animating=!1}))}toggle(){s.isConnected(this._menuNode)?this.hide():this.show()}static autoHide(t){const e=s.getDataset(t,"target"),i=s.find(".selectmenu-menu");for(const n of i){if(t&&s.hasDescendent(n,t))continue;const i=s.getDataset(n,"target");if(i===e)continue;const a=s.findOne(i);this.init(a).hide()}}static init(t,e,i=!1){return s.hasData(t,"selectmenu")?s.getData(t,"selectmenu"):new this(t,e,i)}}s.addEvent(a,"click.frost.selectmenu",t=>{l.autoHide(t.target)}),s.addEventDelegate(a,"click.frost.selectmenu",'[data-toggle="selectmenu"]',t=>{const e=n.getTarget(t.currentTarget);s.getProperty(e,"multiple")?l.init(e).show():l.init(e).toggle()}),s.addEvent(a,"keyup.frost.selectmenu",t=>{switch(t.key){case"Tab":l.autoHide(t.target);break;case"Escape":l.autoHide()}}),Object.assign(l.prototype,{_events(){s.addEventDelegate(this._itemsList,"click.frost.selectmenu",'[data-action="select"]',t=>{t.preventDefault();let e=s.getDataset(t.currentTarget,"value");if(e=this._findValue(e).value,this._multiple){const t=this._value.indexOf(e);t>=0?(this._value.splice(t,1),e=this._value):e=this._value.concat([e])}this.setValue(e),this._settings.closeOnSelect?this.hide():this._getData({}),this._refreshPlaceholder(),s.setValue(this._searchInput,""),s.focus(this._searchInput)}),s.addEvent(this._searchInput,"input.frost.selectmenu",t=>{this._multiple&&this._updateSearchWidth();let e=s.getValue(this._searchInput);e.length<this._settings.minSearch||(this._multiple&&this.show(),s.empty(this._itemsList),this._getData({term:e}))}),this._settings.getResults&&s.addEvent(this._menuNode,"scroll.frost.selectmenu",t=>{if(this._request||!this._showMore)return;const e=s.height(this._menuNode),i=s.height(this._menuNode,DOM.SCROLL_BOX);if(s.getScrollY(this._menuNode)>=i-e-50){const t=s.getValue(this._searchInput),e=this._data.length;this._getData({term:t,offset:e})}}),this._multiple?this._eventsMulti():this._eventsSingle()},_eventsMulti(){s.addEvent(this._node,"focus.frost.selectmenu",t=>{s.focus(this._searchInput)}),s.addEvent(this._searchInput,"focus.frost.selectmenu",t=>{s.hide(this._placeholder),s.detach(this._placeholder),s.addClass(this._toggle,"focus")}),s.addEvent(this._searchInput,"blur.frost.selectmenu",t=>{this._refreshPlaceholder(),s.removeClass(this._toggle,"focus")}),s.addEvent(this._toggle,"mousedown.frost.selectmenu",e=>{s.addClass(this._toggle,"focus"),s.addEventOnce(t,"mouseup.frost.selectmenu",t=>{s.focus(this._searchInput)})}),s.addEventDelegate(this._toggle,"click.frost.selectmenu",'[data-action="clear"]',t=>{t.preventDefault();const e=s.parent(t.currentTarget),i=s.index(e);this._value.splice(i,1),this.setValue(this._value),s.focus(this._searchInput)})},_eventsSingle(){s.addEvent(this._node,"focus.frost.selectmenu",t=>{s.focus(this._toggle)}),s.addEvent(this._toggle,"keydown.frost.selectmenu",t=>{this.show(),s.focus(this._searchInput)}),this._settings.allowClear&&s.addEventDelegate(this._toggle,"click.frost.selectmenu",'[data-action="clear"]',t=>{this.setValue(null)})}}),Object.assign(l.prototype,{_findValue(t){return t in this._lookupData?this._lookupData[t]:null},_refresh(){s.empty(this._node),s.detach(this._placeholder);const t=this._findValue(this._value);if(!t)return s.empty(this._toggle),s.show(this._placeholder),void s.append(this._toggle,this._placeholder);s.append(this._node,t.element);const e=this._settings.renderSelection(t);if(s.setHTML(this._toggle,this._settings.sanitize(e)),this._settings.allowClear){const t=s.create("button",{html:'<small class="icon-cancel"></small>',class:"close float-end me-5 lh-base",dataset:{action:"clear"}});s.append(this._toggle,t)}},_refreshMulti(t=!1){if(this._value||(this._value=[]),this._settings.maxSelect&&this._value.length>this._settings.maxSelect&&(this._value=this._value.slice(0,this._settings.maxSelect)),s.detach(this._searchInput),s.detach(this._placeholder),s.empty(this._node),s.empty(this._toggle),this._value.length)for(const t of this._value){const e=this._findValue(t);if(!e)continue;s.append(this._node,e.element);const i=this._renderMultiSelection(e);s.append(this._toggle,i)}else this._refreshPlaceholder();s.append(this._toggle,this._searchInput),t&&s.focus(this._searchInput)},_refreshPlaceholder(){this._multiple&&(this._value.length?s.hide(this._placeholder):(s.show(this._placeholder),s.prepend(this._toggle,this._placeholder)))},_setValue(t){this._value=t,this._multiple?this._refreshMulti():this._refresh()},_updateSearchWidth(){const t=s.create("span",{text:s.getValue(this._searchInput),class:"d-inline-block",style:{fontSize:s.css(this._searchInput,"fontSize"),whiteSpace:"pre-wrap"}});s.append(a.body,t);const e=s.width(t);s.setStyle(this._searchInput,"width",e+2),s.remove(t)}}),Object.assign(l.prototype,{_render(){this._multiple?this._renderSelectMulti():this._renderSelect(),this._renderPlaceholder(),this._renderMenu(),s.addClass(this._node,"visually-hidden"),s.after(this._node,this._toggle)},_renderItem(t){const e=this._multiple&&this._value.includes(t.value)||!this._multiple&&t.value==this._value,{option:i,...n}=t,a=s.create("li",{html:this._settings.sanitize(this._settings.renderResult(n,e)),class:"selectmenu-item selectmenu-action",dataset:{action:"select",value:t.value}});return e&&s.addClass(a,"active"),a},_renderGroup(t){return s.create("div",{html:this._settings.sanitize(this._settings.renderResult(t)),class:"selectmenu-group"})},_renderMenu(){if(this._menuNode=s.create("div",{class:"selectmenu-menu",dataset:{target:"#"+s.getAttribute(this._node,"id")}}),!this._multiple){const t=s.create("div",{class:"p-1"});s.append(this._menuNode,t);const e=s.create("div",{class:"form-input"});s.append(t,e),this._searchInput=s.create("input",{class:"input-filled"}),s.append(e,this._searchInput);const i=s.create("div",{class:"ripple-line"});s.append(e,i),this._settings.maxSearch&&s.setAttribute(this._searchInput,"maxlength",this._settings.maxSearch)}this._itemsList=s.create("ul",{class:"selectmenu-items"}),s.append(this._menuNode,this._itemsList);const t={reference:this._toggle,placement:this._settings.placement,position:this._settings.position,fixed:this._settings.fixed,spacing:this._settings.spacing,minContact:this._settings.minContact};this._settings.fullWidth&&(t.afterUpdate=(t,e)=>{const i=s.width(e,DOM.BORDER_BOX);s.setStyle(t,"width",i)},t.beforeUpdate=t=>{s.setStyle(t,"width","")}),this._popper=new n.Popper(this._menuNode,t)},_renderMultiSelection(t){const e=s.create("div",{class:"btn-group"}),i=s.create("div",{html:'<small class="icon-cancel"></small>',class:"btn btn-sm btn-outline-secondary",dataset:{action:"clear"}});s.append(e,i);const n=this._settings.renderSelection(t),a=s.create("div",{html:this._settings.sanitize(n),class:"btn btn-sm btn-secondary"});return s.append(e,a),e},_renderPlaceholder(){this._placeholder=s.create("span",{html:this._settings.sanitize(this._settings.placeholder),class:"selectmenu-placeholder"})},_renderResults(t){if(t.length)for(const e of t){const t=e.children?this._renderGroup(e):this._renderItem(e);s.append(this._itemsList,t)}else{const t=s.create("li",{html:this._settings.sanitize(this._settings.lang.noResults),class:"selectmenu-item"});s.append(this._itemsList,t)}},_renderSelectMulti(){this._toggle=s.create("div",{class:[s.getAttribute(this._node,"class")||"","selectmenu-multi d-flex flex-wrap position-relative text-start"],dataset:{toggle:"selectmenu",target:"#"+s.getAttribute(this._node,"id")}}),this._searchInput=s.create("input",{class:"selectmenu-multi-input"}),this._settings.maxSearch&&s.setAttribute(this._searchInput,"maxlength",this._settings.maxSearch)},_renderSelect(){this._toggle=s.create("button",{class:[s.getAttribute(this._node,"class")||"","selectmenu-toggle position-relative text-start"],dataset:{toggle:"selectmenu",target:"#"+s.getAttribute(this._node,"id")}})}}),Object.assign(l.prototype,{data(){if(this._multiple)return this._value.map(t=>{const{option:e,...s}=this._findValue(t);return s});const{option:t,...e}=this._findValue(this._value);return e},getValue(){return this._value},setValue(t){return t?!t||!this._getResults||!this._multiple&&this._findValue(t)||this._multiple&&t.every(t=>this._findValue(t))?this._setValue(t):void this._getResults({value:t}).then(e=>{this._setValue(t)}):this._setValue(t)}}),Object.assign(l,{_buildOption:t=>s.create("option",{text:t.text,value:t.value}),_getDataFromDOM(t){const e=s.children(t),i=[];for(const t of e){const e=s.getText(t),n=s.getDataset(t);s.is(t,"option")?i.push({text:e,value:s.getValue(t),...n}):i.push({text:e,children:this._getDataFromDOM(t),...n})}return i},_getDataFromObject:t=>Object.entries(t).map(([t,e])=>({value:t,text:e})),_parseData(t){for(const e of t)e.children?this._parseData(e.children):e.element=this._buildOption(e);return t},_parseDataLookup(t,e={}){for(const s of t)t.children?this._parseDataLookup(t.children,e):e[s.value]=s;return e}}),l.defaults={data:null,placeholder:"&nbsp;",lang:{loading:"Loading..",maxSelect:"Selection limit reached.",noResults:"No results"},isMatch:(t,e)=>t.text.toLowerCase().indexOf(e.toLowerCase())>-1,renderResult:t=>t.text,renderSelection:t=>t.text,sanitize:t=>s.sanitize(t),sortResults:(t,e)=>t.sort((t,s)=>{const i=t.text.toLowerCase(),n=s.text.toLowerCase();if(e){const t=i.indexOf(e)-n.indexOf(e);if(t)return t}return i.localeCompare(n)}),maxSearch:0,maxSelect:0,minSearch:0,allowClear:!1,closeOnSelect:!0,fullWidth:!0,duration:100,placement:"bottom",position:"start",fixed:!1,spacing:3,minContact:!1},i&&(i.prototype.selectmenu=function(t,...s){let i,n;e.isObject(t)?i=t:e.isString(t)&&(n=t);for(const t of this){if(!e.isElement(t))continue;const a=l.init(t,i);n&&a[n](...s)}return this}),n.SelectMenu=l}));