!function(t,e){"use strict";"object"==typeof module&&"object"==typeof module.exports?module.exports=e:e(t)}(window,(function(t){"use strict";if(!t)throw new Error("FrostUI-SelectMenu requires a Window.");if(!("UI"in t))throw new Error("FrostUI-SelectMenu requires FrostUI.");const e=t.Core,s=t.dom,i=t.QuerySet,n=t.UI,a=t.document;class l{constructor(t,i){let n;this._node=t,this._settings=e.extend({},this.constructor.defaults,s.getDataset(this._node),i),this._placeholderText=this._settings.placeholder,this._maxSelections=this._settings.maxSelections,this._multiple=s.getProperty(this._node,"multiple"),this._disabled=s.getProperty(this._node,"disabled"),this._data=[],this._lookup={},this._getData=null,this._getResults=null,e.isFunction(this._settings.getResults)?(this._getResultsCallbackInit(),this._getResultsInit()):n=e.isPlainObject(this._settings.data)?this.constructor._getDataFromObject(this._settings.data):e.isArray(this._settings.data)?this._settings.data:this.constructor._getDataFromDOM(this._node),n&&(this._data=this.constructor._parseData(n),this._lookup=this.constructor._parseDataLookup(n),this._getDataInit());const a=s.getValue(this._node);this._render(),this._loadValue(a),this._events(),s.setData(this._node,"selectmenu",this)}destroy(){this._popper&&this._popper.destroy(),s.removeEvent(this._node,"focus.frost.selectmenu"),s.removeClass(this._node,"visually-hidden"),s.remove(this._menuNode),s.remove(this._toggle),s.removeData(this._node,"selectmenu")}hide(){!this._animating&&s.isConnected(this._menuNode)&&s.triggerOne(this._node,"hide.frost.selectmenu")&&(this._animating=!0,this._refreshPlaceholder(),s.setValue(this._searchInput,""),s.fadeOut(this._menuNode,{duration:this._settings.duration}).then(t=>{s.empty(this._itemsList),s.detach(this._menuNode),s.setAttribute(this._toggle,"aria-expanded",!1),s.triggerEvent(this._node,"hidden.frost.selectmenu")}).catch(t=>{}).finally(t=>{this._animating=!1}))}show(){this._disabled||this._animating||s.isConnected(this._menuNode)||!s.triggerOne(this._node,"show.frost.selectmenu")||(this._getData({}),this._multiple&&!s.hasChildren(this._itemsList)||(this._animating=!0,s.append(a.body,this._menuNode),this.update(),s.fadeIn(this._menuNode,{duration:this._settings.duration}).then(t=>{s.setAttribute(this._toggle,"aria-expanded",!0),s.triggerEvent(this._node,"shown.frost.selectmenu")}).catch(t=>{}).finally(t=>{this._animating=!1})))}toggle(){s.isConnected(this._menuNode)?this.hide():this.show()}update(){this._popper.update()}static autoHide(t){const e=s.getDataset(t,"target"),i=s.find(".selectmenu-menu");for(const n of i){if(t&&s.hasDescendent(n,t))continue;const i=s.getDataset(n,"target");if(i===e)continue;const a=s.findOne(i);this.init(a).hide()}}static init(t,e){return s.hasData(t,"selectmenu")?s.getData(t,"selectmenu"):new this(t,e)}}Object.assign(l.prototype,{_events(){s.addEvent(this._node,"focus.frost.selectmenu",t=>{this._disabled||(this._multiple?s.focus(this._searchInput):s.focus(this._toggle))}),s.addEvent(this._menuNode,"mousedown.frost.selectmenu",t=>{t.preventDefault()}),s.addEventDelegate(this._itemsList,"mouseup.frost.selectmenu",'[data-action="select"]',t=>{t.preventDefault();const e=s.getDataset(t.currentTarget,"value");this._selectValue(e)}),s.addEventDelegate(this._itemsList,"mouseover.frost.selectmenu",".selectmenu-action:not(.disabled)",t=>{const e=s.findOne(".selectmenu-focus",this._itemsList);s.removeClass(e,"selectmenu-focus"),s.addClass(t.currentTarget,"selectmenu-focus")}),s.addEvent(this._searchInput,"keydown.frost.selectmenu",t=>{if(!["ArrowDown","ArrowUp","Backspace","Enter","Escape"].includes(t.key))return;if("Backspace"===t.key){if(this._multiple&&this._value.length&&!s.getValue(this._searchInput)){t.preventDefault();const e=this._value.pop(),i=this._findValue(e);this._refreshMulti(),s.setValue(this._searchInput,i.text),s.focus(this._searchInput),this._updateSearchWidth(),s.triggerEvent(this._searchInput,"input.frost.selectmenu")}return}if(this._multiple&&!s.isConnected(this._menuNode)&&["ArrowDown","ArrowUp","Enter"].includes(t.key))return this.show();if("Escape"===t.key)return s.blur(this._searchInput),void(this._multiple?s.focus(this._searchInput):s.focus(this._toggle));const e=s.findOne(".selectmenu-focus",this._itemsList);if("Enter"===t.key){if(e){const t=s.getDataset(e,"value");this._selectValue(t)}return}let i;if(e)switch(t.key){case"ArrowDown":i=s.nextAll(e,".selectmenu-action:not(.disabled)").shift();break;case"ArrowUp":i=s.prevAll(e,".selectmenu-action:not(.disabled)").pop()}else i=s.findOne(".selectmenu-action:not(.disabled)",this._itemsList);i&&(s.removeClass(e,"selectmenu-focus"),s.addClass(i,"selectmenu-focus"))}),s.addEvent(this._searchInput,"input.frost.selectmenu",t=>{this._multiple&&this._updateSearchWidth();const e=s.getValue(this._searchInput);e.length<this._settings.minSearch||(this._multiple&&this.show(),s.empty(this._itemsList),this._getData({term:e}))}),this._settings.getResults&&s.addEvent(this._itemsList,"scroll.frost.selectmenu",t=>{if(this._request||!this._showMore)return;const e=s.height(this._itemsList),i=s.height(this._itemsList,DOM.SCROLL_BOX);if(s.getScrollY(this._itemsList)>=i-e-50){const t=s.getValue(this._searchInput),e=this._data.length;this._getData({term:t,offset:e})}}),this._multiple?this._eventsMulti():this._eventsSingle()},_eventsMulti(){s.addEvent(this._searchInput,"focus.frost.selectmenu",t=>{s.hide(this._placeholder),s.detach(this._placeholder),s.addClass(this._toggle,"focus")}),s.addEvent(this._searchInput,"blur.frost.selectmenu",t=>{s.hasDataset(this._toggle,"preFocus")||(s.removeClass(this._toggle,"focus"),this.hide())}),s.addEvent(this._toggle,"mousedown.frost.selectmenu",e=>{s.hasClass(this._toggle,"focus")?s.setDataset(this._toggle,"preFocus",!0):(s.hide(this._placeholder),s.addClass(this._toggle,"focus")),this.show(),s.addEventOnce(t,"mouseup.frost.selectmenu",t=>{s.hasDataset(this._toggle,"preFocus")&&s.removeDataset(this._toggle,"preFocus"),s.focus(this._searchInput)})}),s.addEventDelegate(this._toggle,"click.frost.selectmenu",'[data-action="clear"]',t=>{t.preventDefault();const e=s.parent(t.currentTarget),i=s.index(e);this._value.splice(i,1),this._setValue(this._value),s.focus(this._searchInput)})},_eventsSingle(){s.addEvent(this._searchInput,"blur.frost.selectmenu",t=>{this.hide()}),s.addEvent(this._toggle,"mousedown.frost.selectmenu",e=>{s.isConnected(this._menuNode)?this.hide():(this.show(),s.addEventOnce(t,"mouseup.frost.selectmenu",t=>{s.focus(this._searchInput)}))}),s.addEvent(this._toggle,"keydown.frost.selectmenu",t=>{/^.$/u.test(t.key)&&(this.show(),s.focus(this._searchInput))}),this._settings.allowClear&&s.addEventDelegate(this._toggle,"click.frost.selectmenu",'[data-action="clear"]',t=>{this._setValue(null)})}}),Object.assign(l.prototype,{_cloneValue(t){const s=this._findValue(t);if(!s)return s;const i=e.extend({},s);return delete i.element,i},_findValue(t){return t in this._lookup?this._lookup[t]:null},_loadValue(t){!t||!this._getResults||!this._multiple&&this._findValue(t)||this._multiple&&t.every(t=>this._findValue(t))?this._setValue(t):this._getResults({value:t}).then(e=>this._setValue(t))},_refresh(){this._multiple?this._refreshMulti():this._refreshSingle()},_refreshDisabled(){this._disabled?(s.addClass(this._toggle,"disabled"),this._multiple?s.setAttribute(this._searchInput,"tabindex","-1"):s.setAttribute(this._toggle,"tabindex","-1")):(s.removeClass(this._toggle,"disabled"),this._multiple?s.removeAttribute(this._searchInput,"tabindex"):s.removeAttribute(this._toggle,"tabindex"))},_refreshMulti(){if(this._value||(this._value=[]),this._maxSelections&&this._value.length>this._maxSelections&&(this._value=this._value.slice(0,this._maxSelections)),this._value=this._value.filter(t=>{const e=this._findValue(t);return e&&!e.disabled}),s.detach(this._searchInput),s.empty(this._node),s.empty(this._toggle),this._refreshDisabled(),this._refreshPlaceholder(),this._value.length)for(const t of this._value){const e=this._findValue(t);s.append(this._node,e.element);const i=this._renderMultiSelection(e);s.append(this._toggle,i)}s.append(this._toggle,this._searchInput)},_refreshPlaceholder(){this._value&&this._value.length?s.hide(this._placeholder):(s.show(this._placeholder),s.prepend(this._toggle,this._placeholder))},_refreshSingle(){const t=this._findValue(this._value);if(t&&!t.disabled||(this._value=null),s.empty(this._node),s.empty(this._toggle),this._refreshDisabled(),this._refreshPlaceholder(),!this._value)return;s.append(this._node,t.element);const e=this._settings.renderSelection(t);s.setHTML(this._toggle,this._settings.sanitize(e)),this._settings.allowClear&&s.append(this._toggle,this._clear)},_selectValue(t){const e=this._findValue(t);if(e){if(t=e.value,this._multiple){const e=this._value.indexOf(t);e>=0?(this._value.splice(e,1),t=this._value):t=this._value.concat([t])}this._setValue(t),this._settings.closeOnSelect?this.hide():this._getData({}),this._refreshPlaceholder(),s.setValue(this._searchInput,""),this._multiple?s.focus(this._searchInput):s.focus(this._toggle)}},_setValue(t){this._value=t,this._refresh()},_updateSearchWidth(){const t=s.create("span",{text:s.getValue(this._searchInput),class:"d-inline-block",style:{fontSize:s.css(this._searchInput,"fontSize"),whiteSpace:"pre-wrap"}});s.append(a.body,t);const e=s.width(t);s.setStyle(this._searchInput,"width",e+2),s.remove(t)}}),Object.assign(l.prototype,{_getDataInit(){this._getData=({term:t=null})=>{if(this._settings.minSearch&&(!t||t.length<this._settings.minSearch))return this.update();if(this._multiple&&this._maxSelections&&this._value.length>=this._maxSelections)return this._renderInfo(this._settings.lang.maxSelections);let e=this._data;t&&(e=this._settings.sortResults(e.reduce((t,e)=>(e.children?t.push(...e.children):t.push(e),t),[]),t).filter(e=>this._settings.isMatch(e,t))),this._renderResults(e),this.update()}},_getResultsInit(){this._getData=({offset:t=0,term:e=null})=>{if(this._request&&this._request.cancel&&(this._request.cancel(),this._request=null),t||s.empty(this._itemsList),this._settings.minSearch&&(!e||e.length<this._settings.minSearch))return this.update();if(this._multiple&&this._maxSelections&&this._value.length>=this._maxSelections)return this._renderInfo(this._settings.lang.maxSelections);const i=this._renderInfo(this._settings.lang.loading),n=this._getResults({offset:t,term:e});n.then(t=>{this._renderResults(t.results)}).catch(t=>{}).finally(t=>{s.remove(i),this.update(),this._request===n&&(this._request=null)})}},_getResultsCallbackInit(){this._getResults=t=>{t.offset||(this._data=[]);const e=this._settings.getResults(t);return this._request=Promise.resolve(e),this._request.then(t=>{const e=this.constructor._parseData(t.results);return this._data.push(...e),this._showMore=t.showMore,Object.assign(this._lookup,this.constructor._parseDataLookup(this._data)),t}),this._request}}}),Object.assign(l.prototype,{_render(){this._multiple?this._renderToggleMulti():(this._settings.allowClear&&this._renderClear(),this._renderToggleSingle()),this._renderPlaceholder(),this._renderMenu(),s.addClass(this._node,"visually-hidden"),s.setAttribute(this._node,"tabindex","-1"),s.after(this._node,this._toggle)},_renderClear(){this._clear=s.create("button",{html:'<small class="icon-cancel"></small>',class:"close float-end me-5 lh-base",dataset:{action:"clear"}})},_renderGroup(t){return s.create("div",{html:this._settings.sanitize(this._settings.renderResult(t)),class:"selectmenu-group"})},_renderInfo(t){const e=s.create("button",{html:this._settings.sanitize(t),class:"selectmenu-item text-secondary"});return s.append(this._itemsList,e),this.update(),e},_renderItem(t){const e=this._multiple&&this._value.includes(t.value)||!this._multiple&&t.value==this._value,{option:i,...n}=t,a=s.create("div",{html:this._settings.sanitize(this._settings.renderResult(n,e)),class:"selectmenu-item selectmenu-action",dataset:{action:"select",value:t.value}});return e&&s.addClass(a,"active"),t.disabled&&s.addClass(a,"disabled"),a},_renderMenu(){if(this._menuNode=s.create("div",{class:"selectmenu-menu",dataset:{target:"#"+s.getAttribute(this._node,"id")}}),!this._multiple){const t=s.create("div",{class:"p-1"});s.append(this._menuNode,t);const e=s.create("div",{class:"form-input"});s.append(t,e),this._searchInput=s.create("input",{class:"input-filled"}),s.append(e,this._searchInput);const i=s.create("div",{class:"ripple-line"});s.append(e,i)}this._itemsList=s.create("div",{class:"selectmenu-items"}),s.append(this._menuNode,this._itemsList);const t={reference:this._toggle,placement:this._settings.placement,position:this._settings.position,fixed:this._settings.fixed,spacing:this._settings.spacing,minContact:this._settings.minContact};this._settings.fullWidth&&(t.afterUpdate=(t,e)=>{const i=s.width(e,DOM.BORDER_BOX);s.setStyle(t,"width",i)},t.beforeUpdate=t=>{s.setStyle(t,"width","")}),this._popper=new n.Popper(this._menuNode,t)},_renderMultiSelection(t){const e=s.create("div",{class:"btn-group"}),i=s.create("div",{html:'<small class="icon-cancel"></small>',class:"btn btn-sm btn-outline-secondary",dataset:{action:"clear"}});s.append(e,i);const n=this._settings.renderSelection(t),a=s.create("div",{html:this._settings.sanitize(n),class:"btn btn-sm btn-secondary"});return s.append(e,a),e},_renderPlaceholder(){this._placeholder=s.create("span",{html:this._settings.sanitize(this._placeholderText),class:"selectmenu-placeholder"})},_renderResults(t){if(!t.length)return this._renderInfo(this._settings.lang.noResults);for(const e of t){const t=e.children?this._renderGroup(e):this._renderItem(e);s.append(this._itemsList,t)}let e=s.findOne(".selectmenu-action.active",this._itemsList);e||(e=s.findOne(".selectmenu-action:not(.disabled)",this._itemsList)),e&&s.addClass(e,"selectmenu-focus")},_renderToggleSingle(){this._toggle=s.create("button",{class:[s.getAttribute(this._node,"class")||"","selectmenu-toggle position-relative text-start"],dataset:{target:"#"+s.getAttribute(this._node,"id")}})},_renderToggleMulti(){this._toggle=s.create("div",{class:[s.getAttribute(this._node,"class")||"","selectmenu-multi d-flex flex-wrap position-relative text-start"],dataset:{target:"#"+s.getAttribute(this._node,"id")}}),this._searchInput=s.create("input",{class:"selectmenu-multi-input"})}}),Object.assign(l.prototype,{data(){return this._multiple?this._value.map(t=>this._cloneValue(t)):this._cloneValue(this._value)},disable(){return s.setAttribute(this._node,"disabled",!0),this._disabled=!0,this._refreshDisabled(),this},enable(){return s.removeAttribute(this._node,"disabled"),this._disabled=!1,this._refreshDisabled(),this},getMaxSelections(){return this._maxSelections},getPlaceholder(){return this._placeholderText},getValue(){return this._value},setMaxSelections(t){return this._maxSelections=t,this.hide(),this._refresh(),this},setPlaceholder(t){return this._placeholderText=t,s.remove(this._placeholder),this._renderPlaceholder(),this._refresh(),this},setValue(t){return this._disabled||this._loadValue(t),this}}),Object.assign(l,{_buildOption:t=>s.create("option",{text:t.text,value:t.value,properties:{selected:!0}}),_getDataFromDOM(t){return s.children(t).map(t=>{const e=s.getDataset(t);return s.is(t,"option")?{text:s.getText(t),value:s.getValue(t),...e}:{text:s.getAttribute(t,"label"),children:this._getDataFromDOM(t),...e}})},_getDataFromObject:t=>Object.entries(t).map(([t,e])=>({value:t,text:e})),_parseData(t){for(const e of t)e.children?this._parseData(e.children):e.element=this._buildOption(e);return t},_parseDataLookup(t,s={}){for(const i of t)t.children?this._parseDataLookup(t.children,s):s[i.value]=e.extend({},i);return s}}),l.defaults={placeholder:"",lang:{loading:"Loading..",maxSelections:"Selection limit reached.",noResults:"No results"},data:null,getResults:null,isMatch:(t,e)=>t.text.toLowerCase().indexOf(e.toLowerCase())>-1,renderResult:t=>t.text,renderSelection:t=>t.text,sanitize:t=>s.sanitize(t),sortResults:(t,e)=>t.sort((t,s)=>{const i=t.text.toLowerCase(),n=s.text.toLowerCase();if(e){const t=i.indexOf(e)-n.indexOf(e);if(t)return t}return i.localeCompare(n)}),maxSelections:0,minSearch:0,allowClear:!1,closeOnSelect:!0,fullWidth:!0,duration:100,placement:"bottom",position:"start",fixed:!1,spacing:3,minContact:!1},i&&(i.prototype.selectmenu=function(t,...s){let i,n;e.isObject(t)?i=t:e.isString(t)&&(n=t);for(const t of this){if(!e.isElement(t))continue;const a=l.init(t,i);n&&a[n](...s)}return this}),n.SelectMenu=l}));