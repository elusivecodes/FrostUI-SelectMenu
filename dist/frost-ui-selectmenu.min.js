!function(t,e){"use strict";"object"==typeof module&&"object"==typeof module.exports?module.exports=e:e(t)}(window,(function(t){"use strict";if(!t)throw new Error("FrostUI-SelectMenu requires a Window.");if(!("UI"in t))throw new Error("FrostUI-SelectMenu requires FrostUI.");const e=t.Core,s=t.DOM,i=t.dom,n=t.UI,l=t.document;class a extends n.BaseComponent{constructor(t,s){if(super(t,s),!i.is(this._node,"select"))throw new Error("SelectMenu must be created on a select element");let n,l;this._placeholderText=this._settings.placeholder,this._maxSelections=this._settings.maxSelections,this._multiple=i.getProperty(this._node,"multiple"),this._data=[],this._lookup={},this._getData=null,this._getResults=null,e.isFunction(this._settings.getResults)?(this._getResultsCallbackInit(),this._getResultsInit()):n=e.isPlainObject(this._settings.data)?this.constructor._getDataFromObject(this._settings.data):e.isArray(this._settings.data)?this._settings.data:this.constructor._getDataFromDOM(this._node),n&&(this._data=this.constructor._parseData(n),this._lookup=this.constructor._parseDataLookup(n),this._getDataInit()),l=this._multiple?[...this._node.selectedOptions].map((t=>i.getValue(t))):i.getValue(this._node),this._render(),this._loadValue(l),this._events()}disable(){return i.setAttribute(this._node,"disabled",!0),this._refreshDisabled(),this}dispose(){this._popper&&(this._popper.dispose(),this._popper=null),i.removeAttribute(this._node,"tabindex"),i.removeEvent(this._node,"focus.ui.selectmenu"),i.removeClass(this._node,this.constructor.classes.hide),i.remove(this._menuNode),i.remove(this._toggle),this._toggle=null,this._clear=null,this._searchInput=null,this._placeholder=null,this._menuNode=null,this._itemsList=null,this._data=null,this._lookup=null,this._value=null,this._request=null,this._popperOptions=null,this._getData=null,this._getResults=null,super.dispose()}enable(){return i.removeAttribute(this._node,"disabled"),this._refreshDisabled(),this}hide(){return!this._animating&&i.isConnected(this._menuNode)&&i.triggerOne(this._node,"hide.ui.selectmenu")?(this._animating=!0,this._refreshPlaceholder(),i.setValue(this._searchInput,""),i.fadeOut(this._menuNode,{duration:this._settings.duration}).then((t=>{this._popper.dispose(),this._popper=null,i.empty(this._itemsList),i.detach(this._menuNode),i.setAttribute(this._toggle,"aria-expanded",!1),i.triggerEvent(this._node,"hidden.ui.selectmenu")})).catch((t=>{})).finally((t=>{this._animating=!1})),this):this}show(){return i.is(this._node,":disabled")||i.hasAttribute(this._node,"readonly")||this._animating||i.isConnected(this._menuNode)||!i.triggerOne(this._node,"show.ui.selectmenu")||(this._getData({}),this._animating=!0,this._settings.appendTo?i.append(this._settings.appendTo,this._menuNode):i.after(this._toggle,this._menuNode),this._popper=new n.Popper(this._menuNode,this._popperOptions),i.fadeIn(this._menuNode,{duration:this._settings.duration}).then((t=>{i.setAttribute(this._toggle,"aria-expanded",!0),i.triggerEvent(this._node,"shown.ui.selectmenu")})).catch((t=>{})).finally((t=>{this._animating=!1}))),this}toggle(){return i.isConnected(this._menuNode)?this.hide():this.show()}update(){return this._popper&&this._popper.update(),this}}Object.assign(a.prototype,{data(){return this._multiple?this._value.map((t=>this._cloneValue(t))):this._cloneValue(this._value)},getMaxSelections(){return this._maxSelections},getPlaceholder(){return this._placeholderText},getValue(){return this._value},setMaxSelections(t){return this._maxSelections=t,this.hide(),this._refresh(),this},setPlaceholder(t){return this._placeholderText=t,i.remove(this._placeholder),this._renderPlaceholder(),this._refresh(),this},setValue(t){return i.is(this._node,":disabled")||this._loadValue(t),this}}),Object.assign(a.prototype,{_events(){i.addEventDelegate(this._menuNode,"contextmenu.ui.selectmenu",'[data-ui-action="select"]',(t=>{t.preventDefault()})),i.addEvent(this._menuNode,"mousedown.ui.selectmenu",(t=>{i.isSame(this._searchInput,t.target)||t.preventDefault()})),i.addEvent(this._menuNode,"click.ui.selectmenu",(t=>{t.stopPropagation()})),i.addEvent(this._node,"focus.ui.selectmenu",(t=>{this._multiple?i.focus(this._searchInput):i.focus(this._toggle)})),i.addEventDelegate(this._itemsList,"mouseup.ui.selectmenu",'[data-ui-action="select"]',(t=>{t.preventDefault();const e=i.getDataset(t.currentTarget,"uiValue");this._selectValue(e)})),i.addEventDelegate(this._itemsList,"mouseover.ui.selectmenu",'[data-ui-action="select"]',s.debounce((t=>{const e=i.find("[data-ui-focus]",this._itemsList);i.removeClass(e,this.constructor.classes.focus),i.removeDataset(e,"uiFocus"),i.addClass(t.currentTarget,this.constructor.classes.focus),i.setDataset(t.currentTarget,"uiFocus",!0)})));const t=e.debounce((t=>{this._getData({term:t})}),this._settings.debounceInput);i.addEvent(this._searchInput,"input.ui.selectmenu",s.debounce((e=>{this._multiple&&(this._updateSearchWidth(),this.show());const s=i.getValue(this._searchInput);t(s)}))),i.addEvent(this._searchInput,"keydown.ui.selectmenu",(t=>{if(!["ArrowDown","ArrowUp","Backspace","Enter"].includes(t.code))return;if("Backspace"===t.code){if(this._multiple&&this._value.length&&!i.getValue(this._searchInput)){t.preventDefault();const e=this._value.pop(),s=this._findValue(e);this._refreshMulti(),i.setValue(this._searchInput,s.text),i.focus(this._searchInput),this._updateSearchWidth(),i.triggerEvent(this._searchInput,"input.ui.selectmenu")}return}if(this._multiple&&!i.isConnected(this._menuNode)&&["ArrowDown","ArrowUp","Enter"].includes(t.code))return this.show();const e=i.findOne("[data-ui-focus]",this._itemsList);if("Enter"===t.code){if(e){const t=i.getDataset(e,"uiValue");this._selectValue(t)}return}let s;if(e)switch(t.code){case"ArrowDown":s=i.nextAll(e,'[data-ui-action="select"]').shift();break;case"ArrowUp":s=i.prevAll(e,'[data-ui-action="select"]').pop()}else s=i.findOne('[data-ui-action="select"]',this._itemsList);if(!s)return;i.removeClass(e,this.constructor.classes.focus),i.removeDataset(e,"uiFocus"),i.addClass(s,this.constructor.classes.focus),i.setDataset(s,"uiFocus",!0);const n=i.getScrollY(this._itemsList),l=i.rect(this._itemsList,!0),a=i.rect(s,!0);a.top<l.top?i.setScrollY(this._itemsList,n+a.top-l.top):a.bottom>l.bottom&&i.setScrollY(this._itemsList,n+a.bottom-l.bottom)})),i.addEvent(this._searchInput,"keyup.ui.selectmenu",(t=>{"Escape"===t.code&&i.isConnected(this._menuNode)&&(t.stopPropagation(),this.hide(),this._multiple?(i.blur(this._searchInput),i.focus(this._searchInput)):i.focus(this._toggle))})),this._settings.getResults&&i.addEvent(this._itemsList,"scroll.ui.selectmenu",e.throttle((t=>{if(this._request||!this._showMore)return;const e=i.height(this._itemsList),n=i.height(this._itemsList,s.SCROLL_BOX);if(i.getScrollY(this._itemsList)>=n-e-e/4){const t=i.getValue(this._searchInput),e=this._data.length;this._getData({term:t,offset:e})}}),250,!1)),this._multiple?this._eventsMulti():this._eventsSingle()},_eventsMulti(){i.addEvent(this._searchInput,"focus.ui.selectmenu",(t=>{i.isSame(this._searchInput,l.activeElement)&&(i.hide(this._placeholder),i.detach(this._placeholder),i.addClass(this._toggle,"focus"))}));let e=!1;i.addEvent(this._searchInput,"blur.ui.selectmenu",(t=>{i.isSame(this._searchInput,l.activeElement)||e||(i.removeClass(this._toggle,"focus"),i.isConnected(this._menuNode)?(i.stop(this._menuNode),this._animating=!1,this.hide()):this._refreshPlaceholder())})),i.addEvent(this._toggle,"mousedown.ui.selectmenu",(s=>{i.is(s.target,'[data-ui-action="clear"]')?s.preventDefault():(i.hasClass(this._toggle,"focus")?e=!0:(i.hide(this._placeholder),i.addClass(this._toggle,"focus")),s.button||this.show(),i.focus(this._searchInput),i.addEventOnce(t,"mouseup.ui.selectmenu",(t=>{e=!1,i.focus(this._searchInput)})))})),i.addEventDelegate(this._toggle,"click.ui.selectmenu",'[data-ui-action="clear"]',(t=>{if(t.button)return;const e=i.parent(t.currentTarget),s=i.index(e),n=this._value.slice();n.splice(s,1),this._setValue(n,!0),i.focus(this._searchInput)}))},_eventsSingle(){i.addEvent(this._searchInput,"blur.ui.selectmenu",(t=>{i.isSame(this._searchInput,l.activeElement)||(i.stop(this._menuNode),this._animating=!1,this.hide())})),i.addEvent(this._toggle,"mousedown.ui.selectmenu",(e=>{i.is(e.target,'[data-ui-action="clear"]')?e.preventDefault():e.button||(i.isConnected(this._menuNode)?this.hide():(this.show(),i.addEventOnce(t,"mouseup.ui.selectmenu",(t=>{i.focus(this._searchInput)}))))})),i.addEvent(this._toggle,"keydown.ui.selectmenu",(t=>{/^.$/u.test(t.key)&&(this.show(),i.focus(this._searchInput))})),this._settings.allowClear&&i.addEventDelegate(this._toggle,"click.ui.selectmenu",'[data-ui-action="clear"]',(t=>{t.button||this._setValue(null,!0)}))}}),Object.assign(a.prototype,{_cloneValue(t){const s=this._findValue(t);if(!s)return s;const i=e.extend({},s);return delete i.element,i},_findValue(t){return t in this._lookup?this._lookup[t]:null},_loadValue(t){!t||!this._getResults||!this._multiple&&this._findValue(t)||this._multiple&&t.every((t=>this._findValue(t)))?this._setValue(t):this._getResults({value:t}).then((e=>this._setValue(t)))},_refresh(){this._multiple?this._refreshMulti():this._refreshSingle()},_refreshDisabled(){const t=this._multiple?this._searchInput:this._toggle;i.is(this._node,":disabled")?(i.addClass(this._toggle,this.constructor.classes.disabled),i.setAttribute(t,"tabindex","-1")):(i.removeClass(this._toggle,this.constructor.classes.disabled),i.removeAttribute(t,"tabindex")),i.hasAttribute(this._node,"readonly")&&i.addClass(this._toggle,this.constructor.classes.readonly)},_refreshMulti(){if(this._value||(this._value=[]),this._maxSelections&&this._value.length>this._maxSelections&&(this._value=this._value.slice(0,this._maxSelections)),this._value=this._value.filter((t=>{const e=this._findValue(t);return e&&!e.disabled})),i.detach(this._searchInput),i.empty(this._node),i.empty(this._toggle),this._refreshDisabled(),this._refreshPlaceholder(),this._value.length)for(const t of this._value){const e=this._findValue(t);i.append(this._node,e.element);const s=this._renderMultiSelection(e);i.append(this._toggle,s)}i.append(this._toggle,this._searchInput)},_refreshPlaceholder(){this._multiple&&this._value.length||!this._multiple&&this._value?i.hide(this._placeholder):(i.show(this._placeholder),i.prepend(this._toggle,this._placeholder))},_refreshSingle(){const t=this._findValue(this._value);if(t&&!t.disabled||(this._value=null),i.empty(this._node),i.empty(this._toggle),this._refreshDisabled(),this._refreshPlaceholder(),!this._value)return;i.append(this._node,t.element);const e=this._settings.renderSelection(t);i.setHTML(this._toggle,this._settings.sanitize(e)),this._settings.allowClear&&i.append(this._toggle,this._clear)},_selectValue(t){const e=this._findValue(t);if(e){if(t=e.value,this._multiple){const e=this._value.indexOf(t);e>=0?(t=this._value.slice()).splice(e,1):t=this._value.concat([t])}this._setValue(t,!0),this._settings.closeOnSelect?this.hide():this._getData({}),this._refreshPlaceholder(),i.setValue(this._searchInput,""),this._multiple?i.focus(this._searchInput):i.focus(this._toggle)}},_setValue(t,e=!1){!this._multiple&&t===this._value||this._multiple&&this._value&&t.length===this._value.length&&t.every(((t,e)=>t===this._value[e]))||(this._value=t,this._refresh(),e&&i.triggerEvent(this._node,"change.ui.selectmenu"))},_updateSearchWidth(){const t=i.create("span",{text:i.getValue(this._searchInput),style:{display:"inline-block",fontSize:i.css(this._searchInput,"fontSize"),whiteSpace:"pre-wrap"}});i.append(l.body,t);const e=i.width(t);i.setStyle(this._searchInput,"width",e+2),i.remove(t)}}),Object.assign(a.prototype,{_getDataInit(){this._getData=({term:t=null})=>{if(i.empty(this._itemsList),this._settings.minSearch&&(!t||t.length<this._settings.minSearch))return this.update();if(this._multiple&&this._maxSelections&&this._value.length>=this._maxSelections)return this._renderInfo(this._settings.lang.maxSelections);let e=this._data;t&&(e=this._settings.sortResults(e.reduce(((t,e)=>(e.children?t.push(...e.children):t.push(e),t)),[]),t).filter((e=>this._settings.isMatch(e,t)))),this._renderResults(e),this.update()}},_getResultsInit(){this._getData=({offset:t=0,term:e=null})=>{if(this._request&&this._request.cancel&&(this._request.cancel(),this._request=null),t||i.empty(this._itemsList),this._settings.minSearch&&(!e||e.length<this._settings.minSearch))return this.update();if(this._multiple&&this._maxSelections&&this._value.length>=this._maxSelections)return this._renderInfo(this._settings.lang.maxSelections);const s=this._renderInfo(this._settings.lang.loading),n=this._getResults({offset:t,term:e});n.then((t=>{this._renderResults(t.results)})).catch((t=>{})).finally((t=>{i.remove(s),this.update(),this._request===n&&(this._request=null)}))}},_getResultsCallbackInit(){this._getResults=t=>{t.offset||(this._data=[]);const e=this._settings.getResults(t);return this._request=Promise.resolve(e),this._request.then((t=>{const e=this.constructor._parseData(t.results);return this._data.push(...e),this._showMore=t.showMore,Object.assign(this._lookup,this.constructor._parseDataLookup(this._data)),t})),this._request}}}),Object.assign(a.prototype,{_render(){this._multiple?this._renderToggleMulti():(this._settings.allowClear&&this._renderClear(),this._renderToggleSingle()),this._renderPlaceholder(),this._renderMenu(),i.addClass(this._node,this.constructor.classes.hide),i.setAttribute(this._node,"tabindex","-1"),i.after(this._node,this._toggle)},_renderClear(){this._clear=i.create("button",{class:this.constructor.classes.clear,attributes:{type:"button"},dataset:{uiAction:"clear"}})},_renderGroup(t){return i.create("div",{html:this._settings.sanitize(this._settings.renderResult(t)),class:this.constructor.classes.group})},_renderInfo(t){const e=i.create("button",{html:this._settings.sanitize(t),class:this.constructor.classes.info,attributes:{type:"button"}});return i.append(this._itemsList,e),this.update(),e},_renderItem(t){const e=this._multiple&&this._value.includes(t.value)||!this._multiple&&t.value==this._value,{option:s,...n}=t,l=i.create("div",{html:this._settings.sanitize(this._settings.renderResult(n,e)),class:this.constructor.classes.item});return e&&(i.addClass(l,this.constructor.classes.active),i.setDataset(l,"uiActive",!0)),t.disabled?i.addClass(l,this.constructor.classes.disabledItem):(i.addClass(l,this.constructor.classes.action),i.setDataset(l,{uiAction:"select",uiValue:t.value})),l},_renderMenu(){if(this._menuNode=i.create("div",{class:this.constructor.classes.menu}),!this._multiple){const t=i.create("div",{class:this.constructor.classes.searchOuter});i.append(this._menuNode,t);const e=i.create("div",{class:this.constructor.classes.searchContainer});if(i.append(t,e),this._searchInput=i.create("input",{class:"filled"===this._settings.searchInputStyle?this.constructor.classes.searchInputFilled:this.constructor.classes.searchInputOutline,attributes:{autocomplete:"off"}}),i.append(e,this._searchInput),"filled"===this._settings.searchInputStyle){const t=i.create("div",{class:this.constructor.classes.searchInputRipple});i.append(e,t)}}this._itemsList=i.create("div",{class:this.constructor.classes.items}),i.append(this._menuNode,this._itemsList),this._popperOptions={reference:this._toggle,placement:this._settings.placement,position:this._settings.position,fixed:this._settings.fixed,spacing:this._settings.spacing,minContact:this._settings.minContact},this._settings.fullWidth&&(this._popperOptions.afterUpdate=(t,e)=>{const n=i.width(e,s.BORDER_BOX);i.setStyle(t,"width",n)},this._popperOptions.beforeUpdate=t=>{i.setStyle(t,"width","")})},_renderMultiSelection(t){const e=i.create("div",{class:this.constructor.classes.multiGroup}),s=i.create("div",{html:`<span class="${this.constructor.classes.multiClearIcon}"></span>`,class:this.constructor.classes.multiClear,dataset:{uiAction:"clear"}});i.append(e,s);const{option:n,...l}=t,a=this._settings.renderSelection(l),h=i.create("div",{html:this._settings.sanitize(a),class:this.constructor.classes.multiItem});return i.append(e,h),e},_renderPlaceholder(){this._placeholder=i.create("span",{html:this._placeholderText?this._settings.sanitize(this._placeholderText):"&nbsp;",class:this.constructor.classes.placeholder})},_renderResults(t){if(!t.length)return this._renderInfo(this._settings.lang.noResults);for(const e of t){const t=e.children?this._renderGroup(e):this._renderItem(e);i.append(this._itemsList,t)}if(i.findOne("[data-ui-focus]",this._itemsList))return;let e=i.findOne("[data-ui-active]",this._itemsList);e||(e=i.findOne('[data-ui-action="select"]',this._itemsList)),e&&(i.addClass(e,this.constructor.classes.focus),i.setDataset(e,"uiFocus",!0))},_renderToggleSingle(){this._toggle=i.create("button",{class:[i.getAttribute(this._node,"class")||"",this.constructor.classes.toggle],attributes:{type:"button"}})},_renderToggleMulti(){this._toggle=i.create("div",{class:[i.getAttribute(this._node,"class")||"",this.constructor.classes.multiToggle]}),this._searchInput=i.create("input",{class:this.constructor.classes.multiSearchInput,attributes:{autocomplete:"off"}})}}),Object.assign(a,{_buildOption:t=>i.create("option",{text:t.text,value:t.value,properties:{selected:!0}}),_getDataFromDOM(t){return i.children(t).map((t=>{const e=i.getDataset(t);return i.is(t,"option")?{text:i.getText(t),value:i.getValue(t),...e}:{text:i.getAttribute(t,"label"),children:this._getDataFromDOM(t),...e}}))},_getDataFromObject:t=>Object.entries(t).map((([t,e])=>({value:t,text:e}))),_parseData(t){for(const e of t)e.children?this._parseData(e.children):e.element=this._buildOption(e);return t},_parseDataLookup(t,s={}){for(const i of t)t.children?this._parseDataLookup(t.children,s):s[i.value]=e.extend({},i);return s}}),a.defaults={placeholder:"",lang:{loading:"Loading..",maxSelections:"Selection limit reached.",noResults:"No results"},searchInputStyle:"filled",data:null,getResults:null,isMatch:(t,s)=>{const i=t.text.normalize("NFD").replace(/[\u0300-\u036f]/g,""),n=e.escapeRegExp(s),l=new RegExp(n,"i");return l.test(t.text)||l.test(i)},renderResult:t=>t.text,renderSelection:t=>t.text,sanitize:t=>i.sanitize(t),sortResults:(t,e)=>t.sort(((t,s)=>{const i=t.text.toLowerCase(),n=s.text.toLowerCase();if(e){const t=i.indexOf(e)-n.indexOf(e);if(t)return t}return i.localeCompare(n)})),maxSelections:0,minSearch:0,allowClear:!1,closeOnSelect:!0,debounceInput:250,duration:100,appendTo:null,fullWidth:!1,placement:"bottom",position:"start",fixed:!1,spacing:0,minContact:!1},a.classes={action:"selectmenu-action",active:"selectmenu-active",clear:"btn-close float-end mx-2 lh-base",disabled:"disabled",disabledItem:"selectmenu-disabled",focus:"selectmenu-focus",group:"selectmenu-group",hide:"visually-hidden",info:"selectmenu-item text-secondary",item:"selectmenu-item",items:"selectmenu-items",menu:"selectmenu-menu shadow-sm",multiClear:"btn btn-sm btn-outline-secondary",multiClearIcon:"btn-close pe-none",multiGroup:"btn-group",multiItem:"btn btn-sm btn-secondary",multiSearchInput:"selectmenu-multi-input",multiToggle:"selectmenu-multi d-flex flex-wrap position-relative text-start",placeholder:"selectmenu-placeholder",readonly:"readonly",searchContainer:"form-input",searchInputFilled:"input-filled",searchInputOutline:"input-outline",searchInputRipple:"ripple-line",searchOuter:"p-1",toggle:"selectmenu-toggle position-relative text-start"},n.initComponent("selectmenu",a),n.SelectMenu=a}));